openapi: 3.0.0
info:
  title: Clinical
  version: 1.0.0
security:
  - bearerAuth: ['PROGRAMDATA-${programId}.WRITE', 'CLINICALSERVICE.WRITE']
paths:
  /health:
    get:
      tags:
        - Health
      responses:
        '500':
          description: 'app is not fully healthy'
        '200':
          description: 'all components reporting healthy status'
          content:
            application/json:
              schema:
                type: object

  /admin/submission/lock:
    post:
      tags:
        - Admin
      summary: Set sample registration and clinical submission lock state
      parameters:
        - name: setLock
          description: the boolean state of the submission system lock
          in: query
          required: true
          schema:
            type: boolean
      responses:
        '500':
          description: 'Failed to lock system'
        '200':
          description: 'Sample registration and Clinical Submission lock state has been set'

  /submission/schema:
    get:
      tags:
        - Schemas
      responses:
        '200':
          description: 'the current loaded schema by the clinical submission'
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
    patch:
      tags:
        - Schemas
      description: 'update and load a new schema version from lectern to be used.'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                version:
                  description: the new schema version to update to.
                  type: string
      responses:
        '200':
          description: 'the new schema contents'
          content:
            application/json:
              schema:
                type: object
  /submission/schema/dry-run-update:
    post:
      tags:
        - Schemas
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                version:
                  description: the new schema version to update to.
                  type: string
      responses:
        '200':
          description: na
          content:
            application/json:
              schema:
                type: object
  /submission/schema/migration/resume:
    post:
      tags:
        - Schemas
      responses:
        '200':
          description: 'Resume an active migration'
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
  /submission/schema/migration/{migrationId}:
    get:
      tags:
        - Schemas
      parameters:
        - name: migrationId
          description: the id of a specific migration to fetch
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 'the one matching the id provided'
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
  /submission/schema/migration/:
    get:
      tags:
        - Schemas
      responses:
        '200':
          description: 'A list of all migrations'
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
  /submission/schema/changes:
    get:
      tags:
        - Schemas
      parameters:
        - name: from
          description: the old version
          in: query
          required: true
          schema:
            type: string
        - name: to
          description: the new version
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 'an object containing the diff between the two schema versions & the breaking changes found'
          content:
            application/json:
              schema:
                type: object
  /submission/schema/list:
    get:
      tags:
        - Schemas
      responses:
        '200':
          description: 'a list of all current loaded schema for clinical submission (without sample_registration'
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string

  /submission/schema/template/all:
    get:
      tags:
        - Schemas
      responses:
        '200':
          description: 'A zip file with all schemas'
          content:
            application/zip:
              schema:
                type: string
                format: binary
  /submission/schema/template/{schemaName}:
    parameters:
      - name: schemaName
        description: the name of the schema to generate the template for
        in: path
        required: true
        schema:
          example: 'sample_registration'
          type: string
    get:
      tags:
        - Schemas
      responses:
        '200':
          description: 'A tsv template file for the given schemaName'
          content:
            text/tab-separated-values:
              schema:
                example: 'program_id\tsubmitter_donor_id\tgender\tsubmitter_specimen_id\tspecimen_type\ttumour_normal_designation\tsubmitter_sample_id\tsample_type'
                type: string
  /submission/schema/hack/refresh:
    post:
      tags:
        - Schemas
      description: force reload the schema from the schema service and override the cache
      responses:
        '200':
          description: 'the current loaded schema by the clinical submission'
          content:
            application/json:
              schema:
                type: object
  /submission/schema/hack/replace:
    post:
      tags:
        - Schemas
      description: force replace the schema from the provided schema in body
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: 'the current loaded schema by the clinical submission'
          content:
            application/json:
              schema:
                type: object

  /submission/program/{programId}/registration:
    parameters:
      - name: programId
        description: the short name of the program
        in: path
        required: true
        schema:
          type: string
    get:
      tags:
        - Sample Registration
      summary: Get active registration
      description: returns the current in progress registration for a program if any
      responses:
        '200':
          description: 'the current in progress registration or empty body if nothing found'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Registration'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '500':
          $ref: '#/components/responses/ServerError'
    post:
      tags:
        - Sample Registration
      summary: Upload registration file
      description: This will validate and save the new registration file overwriting any existing registration
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                registrationFile:
                  type: string
                  format: binary
        description: the tsv registration file
        required: true
      responses:
        '400':
          $ref: '#/components/responses/FileStructureError'
        '422':
          description: 'invalid registration file'
          content:
            application/json:
              schema:
                type: object
                properties:
                  successful:
                    type: boolean
                    description: will be false in this case
                  errors:
                    type: array
                    items:
                      $ref: '#/components/schemas/RegistrationValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '500':
          $ref: '#/components/responses/ServerError'
        '201':
          description: 'the file is valid and registration was created'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateRegistration'
  /submission/program/{programId}/registration/{id}:
    delete:
      tags:
        - Sample Registration
      summary: Clear active registration
      description: Removes all active registration data for this program
      parameters:
        - name: id
          description: the id of the registration
          in: path
          required: true
          schema:
            type: string
        - name: programId
          description: the short name of the program
          in: path
          required: true
          schema:
            type: string
      responses:
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
        '200':
          description: 'the registration was deleted from db'
  /submission/program/{programId}/registration/{id}/commit:
    post:
      tags:
        - Sample Registration
      summary: Commit registration
      description: Save the active registration data for this program, registering IDs for all new Samples, Specimens, and Donors introduced
      parameters:
        - name: id
          description: the id of the registration
          in: path
          required: true
          schema:
            type: string
        - name: programId
          description: the short name of the program
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 'The registration was committed and the donors / specimens / samples added to the clinical db'
          content:
            application/json:
              schema:
                type: object
                properties:
                  newSamples:
                    type: array
                    items:
                      type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '500':
          $ref: '#/components/responses/ServerError'
  /submission/program/{programId}/clinical/:
    get:
      tags:
        - Submission
      parameters:
        - name: programId
          description: the short name of the program
          in: path
          required: true
          schema:
            type: string
      summary: Get active submission for a program
      description: returns the current in progress submission for a program if any
      responses:
        '200':
          description: 'the current in progress clinical submission or empty body if nothing found'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClinicalSubmission'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '500':
          $ref: '#/components/responses/ServerError'
  /submission/program/{programId}/clinical/upload:
    post:
      tags:
        - Submission
      summary: Upload clinical submission files
      parameters:
        - $ref: '#/components/parameters/PathProgramId'
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                clinicalFiles:
                  type: array
                  items:
                    type: string
                    format: binary
        description: the tsv clinical submission file
        required: true
      responses:
        '200':
          description: 'the current in progress clinical submission'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateSubmission'
        '207':
          description: 'successful schema validation with some unprocessable files'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateSubmission'
        '422':
          description: 'unsuccessful schema validation failed on files'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateSubmission'
  /submission/program/{programId}/clinical/{versionId}/{fileType}:
    delete:
      tags:
        - Submission
      summary: Remove file from the active submission
      parameters:
        - $ref: '#/components/parameters/PathProgramId'
        - $ref: '#/components/parameters/PathVersionId'
        - name: fileType
          description: the type name of the file that should be cleared, ex. 'specimen'
          in: path
          required: true
          schema:
            type: string
      description: Clears data for the specified file type from the active submission, removes all validation and resets the submission status to OPEN. Cannot be performed if the submission is in PENDING_APPROVAL state.
      responses:
        '200':
          description: 'Data cleared succesfully. Returns the current active clinical submission or empty body if no submission data is available.'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClinicalSubmission'
        '400':
          description: Version ID does not match version of active submission.
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '409':
          description: Active submission is not in a state that can be cleared (ex. PENDING_APPROVAL)
        '500':
          $ref: '#/components/responses/ServerError'
  /submission/program/{programId}/clinical/{versionId}/all:
    delete:
      tags:
        - Submission
      summary: Remove all data from the active clinical submission
      parameters:
        - $ref: '#/components/parameters/PathProgramId'
        - $ref: '#/components/parameters/PathVersionId'
      description: Clears all data from the active submission. Removes all validation and deletes the submission. Cannot be performed if the submission is in PENDING_APPROVAL state.
      responses:
        '200':
          description: 'Data cleared succesfully. Returns the current active clinical submission or empty body if no submission data is available.'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClinicalSubmission'
        '400':
          description: Version ID does not match version of active submission.
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '409':
          description: Active submission is not in a state that can be cleared (ex. PENDING_APPROVAL)
        '500':
          $ref: '#/components/responses/ServerError'
  /submission/program/{programId}/clinical/validate/{versionId}:
    post:
      tags:
        - Submission
      summary: Validate data for clinical submission
      parameters:
        - $ref: '#/components/parameters/PathProgramId'
        - $ref: '#/components/parameters/PathVersionId'
      responses:
        '200':
          description: 'in progress submission with a VALID or PENDING_APPROVAL state'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClinicalSubmission'
        '422':
          description: 'invalid clinical submission, see error messages'
          content:
            application/json:
              schema:
                type: object
                properties:
                  successful:
                    type: boolean
                    description: will be false in this case
                  errors:
                    type: array
                    items:
                      $ref: '#/components/schemas/ValidationError'
  /submission/program/{programId}/clinical/commit/{versionId}:
    post:
      tags:
        - Submission
      summary: Commit data from clinical submission
      description: Commit in progress clinical submission to the clinical DB. Requires Submission to be in VALID state.
      parameters:
        - $ref: '#/components/parameters/PathProgramId'
        - $ref: '#/components/parameters/PathVersionId'
      responses:
        '200':
          description: The uploaded clinical submission data was committed to the clinical DB
        '400':
          description: Version ID does not match version of active submission
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '409':
          description: Active submission is not in VALID state and cannot be commited, or another data issue was found that prevented successfully committing the data.
        '500':
          $ref: '#/components/responses/ServerError'
  /submission/program/{programId}/clinical/approve/{versionId}:
    post:
      tags:
        - Submission
      summary: Approve a clinical submission
      description: Approve and commit in progress clinical submission to the clinical DB. Requires Submission to be in PENDING_APPROVAL state, and can only be performed by a DCC Admin user.
      parameters:
        - $ref: '#/components/parameters/PathProgramId'
        - $ref: '#/components/parameters/PathVersionId'
      responses:
        '200':
          description: The uploaded clinical submission data was committed to the clinical DB
        '400':
          description: Version ID does not match version of active submission
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '409':
          description: Active submission is not in PENDING_APPROVAL state and cannot be commited, or another data issue was found that prevented successfully committing the data.
        '500':
          $ref: '#/components/responses/ServerError'
  /submission/program/{programId}/clinical/reopen/{versionId}:
    post:
      tags:
        - Submission
      summary: Reopen a clinical submission
      description: Reopen in progress clinical submission (clears all stats). Requires Submission to be in PENDING_APPROVAL state, and can only be performed by a DCC Admin user.
      parameters:
        - $ref: '#/components/parameters/PathProgramId'
        - $ref: '#/components/parameters/PathVersionId'
      responses:
        '200':
          description: The uploaded clinical submission data was reopened
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClinicalSubmission'
        '400':
          description: Version ID does not match version of active submission
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '409':
          description: Active submission is not in PENDING_APPROVAL state and cannot be reopned
        '500':
          $ref: '#/components/responses/ServerError'

  /clinical/donors:
    get:
      tags:
        - Clinical Data
      parameters:
        - name: programId
          description: the short name of the program
          in: query
          required: false
          schema:
            type: string
      responses:
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '500':
          $ref: '#/components/responses/ServerError'
        '200':
          description: 'List of donors for the given program'
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
    delete:
      tags:
        - Clinical Data
      parameters:
        - name: programId
          description: the short name of the program
          in: query
          required: false
          schema:
            type: string
      responses:
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '500':
          $ref: '#/components/responses/ServerError'
        '200':
          description: 'all donors deleted'
  /clinical/donors/id:
    get:
      tags:
        - Clinical Data
      parameters:
        - $ref: '#/components/parameters/QueryProgramId'
        - $ref: '#/components/parameters/QuerySubmitterId'
      responses:
        '200':
          description: the id of the donor
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: no matching donor found
  /clinical/specimens/id:
    get:
      tags:
        - Clinical Data
      parameters:
        - $ref: '#/components/parameters/QueryProgramId'
        - $ref: '#/components/parameters/QuerySubmitterId'
      responses:
        '200':
          description: the id of the specimen
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: no matching specimen found
  /clinical/samples/id:
    get:
      tags:
        - Clinical Data
      parameters:
        - $ref: '#/components/parameters/QueryProgramId'
        - $ref: '#/components/parameters/QuerySubmitterId'
      responses:
        '200':
          description: the id of the sample
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: no matching sample found

servers:
  - url: /
tags:
  - name: Health
    description: Service status monitoring
  - name: Admin
    description: Admin functions
  - name: Schemas
    description: View and manage the Data Schema used by Argo-Clinical
  - name: Sample Registration
    description: Registering new Donors, Specimens, and Samples
  - name: Submission
    description: Uploading, Validating, and Committing clinical data
  - name: Clinical Data
    description: ''

components:
  parameters:
    QueryProgramId:
      name: programId
      description: Short Name of the program (ex. ABCD-EF)
      in: query
      required: true
      schema:
        type: string
    QuerySubmitterId:
      name: submitterId
      description: Submitter Id of the entity
      in: query
      required: true
      schema:
        type: string
    PathProgramId:
      name: programId
      description: Short Name of the program (ex. ABCD-EF)
      in: path
      required: true
      schema:
        type: string
    PathVersionId:
      name: versionId
      description: UUID used to confirm the registration/submission version
      in: path
      required: true
      schema:
        type: string
  responses:
    UnauthorizedError:
      description: Access token is missing or invalid
    ServerError:
      description: Server error
    ForbiddenError:
      description: Access token has incorrect scopes
    NotFoundError:
      description: Requested resource was not found
    FileStructureError:
      description: File structure couldn't be parsed correctly, or has an invalid filename
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
              code:
                type: string
                enum: ['TSV_PARSING_FAILED', 'INVALID_FILE_NAME']
          examples:
            TSVParseError:
              value:
                msg: 'string'
                code: 'TSV_PARSING_FAILED'
            InvalidFileNameError:
              value:
                msg: 'string'
                code: 'INVALID_FILE_NAME'
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    BatchError:
      type: object
      properties:
        message:
          type: string
          description: a message describing the error
        type:
          type: string
          description: the type of error
          enum:
            - TSV_PARSING_FAILED
            - INVALID_FILE_NAME
            - MULTIPLE_TYPED_FILES
            - UNRECOGNIZED_HEADER
            - MISSING_REQUIRED_HEADER
        batchNames:
          type: array
          description: list of batch names causing error
          items:
            type: string
    ValidationError:
      type: object
      required:
        - index
        - type
        - fieldName
        - message
        - info
      properties:
        fieldName:
          type: string
          description: the field name that the error is related to
        info:
          type: object
          description: contains context information related to the error
          properties:
            value:
              type: string
              nullable: true
              description: the faulty value
            donorSubmitterId:
              type: string
              nullable: true
              description: the donor Id in that row
          additionalProperties: true
        index:
          type: number
          format: integer
          description: the 0 based index of the row for this error
        type:
          type: string
          description: the type of error
          enum:
            - CONFLICTING_TIME_INTERVAL
            - ID_NOT_REGISTERED
            - INVALID_PROGRAM_ID
            - MUTATING_EXISTING_DATA
            - NEW_DONOR_CONFLICT
            - NEW_SAMPLE_ATTR_CONFLICT
            - NEW_SAMPLE_ID_CONFLICT
            - NEW_SPECIMEN_ATTR_CONFLICT
            - NEW_SPECIMEN_ID_CONFLICT
            - NOT_ENOUGH_INFO_TO_VALIDATE
            - SAMPLE_BELONGS_TO_OTHER_SPECIMEN
            - SPECIMEN_BELONGS_TO_OTHER_DONOR
            # dictionary schema errors
            - MISSING_REQUIRED_FIELD
            - INVALID_FIELD_VALUE_TYPE
            - INVALID_BY_REGEX
            - INVALID_BY_SCRIPT
            - INVALID_ENUM_VALUE
    RegistrationValidationError: # "extends" ValidationError
      allOf:
        - $ref: '#/components/schemas/ValidationError'
        - properties:
            info:
              properties:
                sampleSubmitterId:
                  type: string
                  nullable: true
                  description: the sample Id in that row
                specimenSubmitterId:
                  type: string
                  nullable: true
                  description: the specimen Id in that row
    ValidationUpdate:
      type: object
      required:
        - fieldName
        - info
        - index
      properties:
        fieldName:
          type: string
          description: the field name that the error is related to
        info:
          type: object
          description: contains context information related to the update
          properties:
            oldValue:
              type: string
              nullable: true
              description: the old value in the field
            newValue:
              type: string
              nullable: true
              description: the new value in the field
            donorSubmitterId:
              type: string
              nullable: true
              description: the donor Id in that row
        index:
          type: number
          format: integer
          description: the 0 based index of the row for this error

    Registration:
      type: object
      required:
        - _id
        - programId
        - creator
        - stats
        - records
      properties:
        _id:
          type: string
          description: the id of the registration
        programId:
          type: string
          description: the program short name this registration is for
        creator:
          type: string
          description: first name and last name of the user who created this registration
        batchName:
          type: string
          description: a file that must start with registration and have .tsv extension
        stats:
          type: object
          properties:
            newDonorIds:
              $ref: '#/components/schemas/RegistrationStat'
            newSpecimenIds:
              $ref: '#/components/schemas/RegistrationStat'
            newSampleIds:
              $ref: '#/components/schemas/RegistrationStat'
            alreadyRegistered:
              $ref: '#/components/schemas/RegistrationStat'
        records:
          type: array
          items:
            $ref: '#/components/schemas/Record'
    ClinicalSubmission:
      type: object
      required:
        - _id
        - programId
        - version
        - clinicalEntities
        - state
        - updatedBy
        - updatedAt
      properties:
        _id:
          type: string
          description: the id of the registration
        programId:
          type: string
          description: the program short name this registration is for
        state:
          type: string
          description: the state of the submission
          enum: ['OPEN', 'VALID', 'INVALID', 'PENDING_APPROVAL']
        version:
          type: string
          description: uuid used to ensure that correct version of submission is being updated
        updatedBy:
          type: string
          description: the lastest user to update the submission
        updatedAt:
          type: string
          description: the date/time of the last update
        clinicalEntities:
          type: object
          description: submitted clinical data mapped to a clinical type
          properties:
            clinicalType:
              $ref: '#/components/schemas/ClinicalEntity'
    ClinicalEntity:
      required:
        - batchName
        - creator
        - records
        - dataErrors
      properties:
        batchName:
          type: string
          description: a file that must start with entity type (e.g. donor, sample) and have .tsv extension
        creator:
          type: string
          description: first name and last name of the user who add this entity data
        records:
          type: array
          items:
            $ref: '#/components/schemas/Record'
        dataErrors:
          type: array
          items:
            $ref: '#/components/schemas/ValidationError'
        dataUpdates:
          type: array
          items:
            $ref: '#/components/schemas/ValidationUpdate'

    Record:
      required:
        - program_id
        - submitter_donor_id
        - gender
        - submitter_specimen_id
        - specimen_tissue_source
        - tumour_normal_designation
        - submitter_sample_id
        - sample_type
      properties:
        program_id:
          type: string
        submitter_donor_id:
          type: string
        gender:
          type: string
        submitter_specimen_id:
          type: string
        specimen_tissue_source:
          type: string
        tumour_normal_designation:
          type: string
        submitter_sample_id:
          type: string
        sample_type:
          type: string

    RegistrationStat:
      type: object

    CreateRegistration:
      required:
        - successful
      type: object
      properties:
        registration:
          $ref: '#/components/schemas/Registration'
        successful:
          type: boolean
          description: whether the file was valid or not
        errors:
          type: array
          description: list of all errors, should be empty on success
          items:
            $ref: '#/components/schemas/RegistrationValidationError'
        batchErrors:
          type: array
          description: list of all batch related errors, should be empty on success
          items:
            $ref: '#/components/schemas/BatchError'

    CreateSubmission:
      required:
        - successful
        - submission
      type: object
      properties:
        submission:
          $ref: '#/components/schemas/ClinicalSubmission'
        successful:
          type: boolean
          description: whether the file was valid or not
        schemaErrors:
          type: array
          description: list of all schema errors, should be empty on success
          items:
            $ref: '#/components/schemas/ValidationError'
        batchErrors:
          type: array
          description: list of all batch related errors, should be empty on success
          items:
            $ref: '#/components/schemas/BatchError'
